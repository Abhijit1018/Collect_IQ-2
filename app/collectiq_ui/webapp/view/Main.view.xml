<mvc:View
    controllerName="my.collectiq.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    height="100%">
    
    <Page 
        id="customersPage"
        showHeader="true"
        enableScrolling="true"
        class="sapUiNoContentPadding customersPageBg"
        tooltip="CollectiQ Customer Collection Management Dashboard">
        
        <!-- Custom Header - Matching Dashboard Theme -->
        <customHeader>
            <OverflowToolbar class="customersHeader">
                <HBox alignItems="Center">
                    <core:Icon 
                        src="sap-icon://customer-financial-fact-sheet" 
                        size="1.5rem"
                        color="#fff"
                        class="sapUiSmallMarginEnd"/>
                    <Title text="CollectIQ" level="H3" class="headerTitleWhite"/>
                </HBox>
                <ToolbarSpacer/>
                <SearchField 
                    id="searchField"
                    placeholder="Search customers..."
                    width="350px"
                    liveChange="onSearch"
                    class="headerSearchField"
                    tooltip="Search by name, ID, or email"/>
                <ToolbarSpacer/>
                <Button 
                    text="Dashboard" 
                    icon="sap-icon://home"
                    press="onNavToDashboard"
                    type="Default"
                    class="navButton"
                    tooltip="Go to Analytics Dashboard"/>
                <Button 
                    text="Follow-ups" 
                    icon="sap-icon://appointment"
                    press="onNavToFollowups"
                    type="Default"
                    class="navButton"
                    tooltip="View Scheduled Follow-ups"/>
                <Button 
                    text="Call History" 
                    icon="sap-icon://phone"
                    press="onNavToCallHistory"
                    type="Default"
                    class="navButton"
                    tooltip="View Call Transcripts"/>
                <ToolbarSeparator/>
                <Button 
                    icon="sap-icon://refresh"
                    type="Transparent"
                    press="onRefresh"
                    tooltip="Refresh customer list"/>
            </OverflowToolbar>
        </customHeader>
        
        <content>
            <VBox class="sapUiSmallMargin">
                
                <!-- Quick Stats Bar -->
                <HBox justifyContent="SpaceBetween" alignItems="Center" class="quickStatsBar sapUiSmallMarginBottom">
                    <HBox alignItems="Center">
                        <core:Icon src="sap-icon://customer" size="1.2rem" color="#0056b3" class="sapUiSmallMarginEnd"/>
                        <Text text="Total Customers: " class="statsLabel"/>
                        <Text text="{customerStats>/totalCustomers}" class="statsValue"/>
                    </HBox>
                    <HBox alignItems="Center">
                        <core:Icon src="sap-icon://money-bills" size="1.2rem" color="#dc3545" class="sapUiSmallMarginEnd"/>
                        <Text text="Total Outstanding: " class="statsLabel"/>
                        <Text text="{customerStats>/totalOutstanding}" class="statsValueDanger"/>
                    </HBox>
                    <HBox alignItems="Center">
                        <core:Icon src="sap-icon://warning" size="1.2rem" color="#ffc107" class="sapUiSmallMarginEnd"/>
                        <Text text="Stage 3 Accounts: " class="statsLabel"/>
                        <Text text="{customerStats>/stage3Count}" class="statsValueWarning"/>
                    </HBox>
                    <HBox alignItems="Center">
                        <core:Icon src="sap-icon://email" size="1.2rem" color="#28a745" class="sapUiSmallMarginEnd"/>
                        <Text text="Pending Outreach: " class="statsLabel"/>
                        <Text text="{customerStats>/pendingOutreach}" class="statsValueSuccess"/>
                    </HBox>
                </HBox>
                
                <!-- Main Panel with Actions -->
                <Panel class="customersPanel">
                    <headerToolbar>
                        <OverflowToolbar class="customersPanelHeader">
                            <Title text="Customer Accounts" level="H4" class="panelTitle"/>
                            <ToolbarSpacer/>
                            
                            <!-- Stage Filter Pills -->
                            <SegmentedButton id="stageFilterSegmented" selectionChange="onStageFilterChange">
                                <items>
                                    <SegmentedButtonItem key="ALL" text="All" tooltip="Show all customers"/>
                                    <SegmentedButtonItem key="STAGE_1" text="Stage 1" tooltip="New accounts"/>
                                    <SegmentedButtonItem key="STAGE_2" text="Stage 2" tooltip="Follow-up required"/>
                                    <SegmentedButtonItem key="STAGE_3" text="Stage 3" tooltip="Escalated accounts"/>
                                </items>
                            </SegmentedButton>
                            
                            <ToolbarSeparator/>
                            
                            <Button 
                                id="generateOutreachBtn"
                                text="Generate Outreach" 
                                icon="sap-icon://create" 
                                type="Emphasized"
                                press="onGenerateOutreachAll"
                                tooltip="Generate AI drafts for selected customers"/>
                            <Button 
                                id="sendOutreachBtn"
                                text="Send Outreach" 
                                icon="sap-icon://email-read" 
                                type="Accept"
                                press="onSendOutreachAll"
                                tooltip="Send outreach to selected customers"/>
                            <Button 
                                icon="sap-icon://action-settings"
                                type="Transparent"
                                press="onOpenSettings"
                                tooltip="Table settings"/>
                            <Button 
                                icon="sap-icon://excel-attachment" 
                                type="Transparent"
                                press="onExportPayers" 
                                tooltip="Export to Excel"/>
                        </OverflowToolbar>
                    </headerToolbar>
                    
                    <content>
                        <!-- Customer Table - Enhanced -->
                        <Table
                            id="customerTable"
                            items="{
                                path: '/Payers',
                                parameters: {
                                    $expand: 'Invoices'
                                },
                                sorter: {
                                    path: 'TotalPastDue',
                                    descending: true
                                }
                            }"
                            growing="true"
                            growingThreshold="20"
                            mode="MultiSelect"
                            itemPress="onItemPress"
                            class="customersTable"
                            sticky="ColumnHeaders"
                            tooltip="Click on any row to see full customer details">
                            
                            <columns>
                                <Column width="20%" tooltip="Customer company name">
                                    <Text text="Customer"/>
                                </Column>
                                <Column width="12%" hAlign="End" tooltip="Total outstanding amount">
                                    <Text text="Outstanding"/>
                                </Column>
                                <Column width="8%" hAlign="Center" tooltip="Days past due">
                                    <Text text="Days"/>
                                </Column>
                                <Column width="10%" hAlign="Center" tooltip="Collection stage">
                                    <Text text="Stage"/>
                                </Column>
                                <Column width="12%" hAlign="Center" tooltip="Last outreach status" minScreenWidth="Tablet" demandPopin="true">
                                    <Text text="Status"/>
                                </Column>
                                <Column width="20%" tooltip="Contact information" minScreenWidth="Desktop" demandPopin="true">
                                    <Text text="Contact"/>
                                </Column>
                                <Column width="18%" hAlign="Center" tooltip="Quick actions">
                                    <Text text="Actions"/>
                                </Column>
                            </columns>
                            
                            <items>
                                <ColumnListItem 
                                    type="Navigation"
                                    press="onItemPress"
                                    highlight="{= ${Stage} === 'STAGE_3' ? 'Error' : (${Stage} === 'STAGE_2' ? 'Warning' : 'Success')}"
                                    tooltip="Click to view details for {PayerName}">
                                    <cells>
                                        <!-- Customer Name + ID -->
                                        <VBox>
                                            <ObjectIdentifier 
                                                title="{PayerName}"
                                                text="{PayerId}"
                                                titleActive="true"
                                                titlePress="onItemPress"/>
                                        </VBox>
                                        
                                        <!-- Total Past Due -->
                                        <ObjectNumber
                                            number="{
                                                path: 'TotalPastDue',
                                                formatter: '.formatter.formatCurrency'
                                            }"
                                            unit="{Currency}"
                                            state="{= ${TotalPastDue} > 50000 ? 'Error' : (${TotalPastDue} > 25000 ? 'Warning' : 'Success')}"
                                            emphasized="true"/>
                                        
                                        <!-- Days Past Due with Progress -->
                                        <VBox alignItems="Center">
                                            <ObjectStatus
                                                text="{MaxDaysPastDue} days"
                                                state="{= ${MaxDaysPastDue} > 60 ? 'Error' : (${MaxDaysPastDue} > 30 ? 'Warning' : 'Success')}"
                                                icon="{= ${MaxDaysPastDue} > 60 ? 'sap-icon://warning2' : ''}"/>
                                        </VBox>
                                        
                                        <!-- Stage Badge -->
                                        <ObjectStatus
                                            text="{Stage}"
                                            state="{= ${Stage} === 'STAGE_3' ? 'Error' : (${Stage} === 'STAGE_2' ? 'Warning' : 'Success')}"
                                            icon="{= ${Stage} === 'STAGE_3' ? 'sap-icon://alert' : (${Stage} === 'STAGE_2' ? 'sap-icon://notification-2' : 'sap-icon://accept')}"
                                            inverted="true"/>
                                        
                                        <!-- Last Outreach Status -->
                                        <VBox>
                                            <ObjectStatus
                                                text="{LastOutreachStatus}"
                                                state="{= ${LastOutreachStatus} === 'SENT' || ${LastOutreachStatus} === 'Call Completed' ? 'Success' : (${LastOutreachStatus} === 'PENDING' ? 'Warning' : 'Information')}"/>
                                            <Text 
                                                text="{
                                                    path: 'lastOutreachAt',
                                                    formatter: '.formatter.formatDate'
                                                }" 
                                                class="sapUiTinyMarginTop dateText"/>
                                        </VBox>
                                        
                                        <!-- Contact Info -->
                                        <VBox>
                                            <Link 
                                                text="{ContactEmail}" 
                                                href="mailto:{ContactEmail}"
                                                wrapping="true"/>
                                            <Text 
                                                text="{ContactPhone}" 
                                                class="sapUiTinyMarginTop phoneText"/>
                                        </VBox>
                                        
                                        <!-- Quick Actions -->
                                        <HBox justifyContent="Center">
                                            <Button 
                                                icon="sap-icon://create" 
                                                type="Transparent"
                                                press="onQuickGenerateOutreach"
                                                tooltip="Generate draft"/>
                                            <Button 
                                                icon="sap-icon://email" 
                                                type="Transparent"
                                                press="onQuickSendOutreach"
                                                tooltip="Send outreach"/>
                                            <Button 
                                                icon="sap-icon://phone" 
                                                type="Transparent"
                                                press="onQuickCall"
                                                tooltip="Call customer"/>
                                            <Button 
                                                icon="sap-icon://detail-view" 
                                                type="Transparent"
                                                press="onItemPress"
                                                tooltip="View details"/>
                                        </HBox>
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </content>
                </Panel>
            </VBox>
        </content>
        
        <!-- Footer -->
        <footer>
            <OverflowToolbar class="customersFooter">
                <ToolbarSpacer/>
                <Label text="Selected:" class="sapUiTinyMarginEnd"/>
                <Text id="selectedCountText" text="0 customers"/>
                <ToolbarSeparator/>
                <Label text="Total Outstanding Selected:" class="sapUiTinyMarginEnd"/>
                <Text id="selectedAmountText" text="$0"/>
                <ToolbarSpacer/>
            </OverflowToolbar>
        </footer>
    </Page>
</mvc:View>
